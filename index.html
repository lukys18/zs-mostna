<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Z≈† Mostn√° - Asistent</title>
  <meta name="description" content="AI asistent Z√°kladnej ≈°koly Mostn√° v Nov√Ωch Z√°mkoch - pomoc pre rodiƒçov, ≈æiakov a n√°v≈°tevn√≠kov">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="bot.css">
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script type="text/javascript">
    (function(){
      emailjs.init({
        publicKey: "iCicHuzNS-i1Q67lH",
      });
    })();
  </script>
</head>
<body>
  <div id="chatbot-container" class="closed">
    <div id="chatbot-header" onclick="toggleChatbot()">
      <div class="user-info">
        <div class="avatar-wrapper">
          <div class="avatar-icon">
            <i class="fas fa-graduation-cap"></i>
          </div>
          <div class="status-indicator"></div>
        </div>
        <div class="user-details">
          <div class="user-name">Asistent Z≈† Mostn√°</div>
          <div class="user-status">Online</div>
        </div>
      </div>
      
      <div class="header-actions">
        <button id="reset-chat-btn" onclick="resetChat(event)" title="Resetova≈• konverz√°ciu">
          <i class="fas fa-redo"></i>
        </button>
        <span id="toggle-icon">+</span>
      </div>
    </div>

    <div id="chatbot-header-closed" onclick="toggleChatbot()" style="display: none;">
      <span class="closed-bot-text">Asistent Z≈† Mostn√°</span>
    </div>

    <div id="chatbot-body">
      <div id="chat-messages"></div>
      <div id="input-area">
        <textarea id="user-input" placeholder="Nap√≠≈°te spr√°vu..."></textarea>
        <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
      </div>
      <div id="chatbot-footer">
        Vyrobil <a href="https://ragnetiq.com/" target="_blank" rel="noopener noreferrer">Ragnetiq</a>
      </div>
    </div>
  </div>

<script src="database.js"></script>
<script src="rag-system.js"></script>

<script>
  let sessionId = null;
  let messageIndex = 0;
  let emailSubmittedInSession = false;
  let ipAddress = null;
  let geoLocationCity = null;
  
  function getSessionId() {
    if (!sessionId) {
      sessionId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    return sessionId;
  }
  
  function markEmailSubmittedForSession() {
    emailSubmittedInSession = true;
  }
  
  async function initializeIPAndGeo() {
    try {
      const ipResponse = await fetch('https://api.ipify.org?format=json');
      const ipData = await ipResponse.json();
      ipAddress = ipData.ip;
      
      const geoResponse = await fetch(`https://ipapi.co/${ipAddress}/json/`);
      const geoData = await geoResponse.json();
      geoLocationCity = geoData.city || null;
    } catch (error) {
      console.error('Chyba pri z√≠skavan√≠ IP/Geo:', error);
    }
  }
  
  function categorizeMessage(message) {
    const msgLower = message.toLowerCase();
    
    if (msgLower.includes('rozvrh') || msgLower.includes('hodina') || msgLower.includes('vyuƒçovanie')) {
      return 'rozvrh';
    } else if (msgLower.includes('kontakt') || msgLower.includes('email') || msgLower.includes('telef√≥n')) {
      return 'kontakt';
    } else if (msgLower.includes('kr√∫≈æok') || msgLower.includes('z√°ujmov') || msgLower.includes('aktivit')) {
      return 'kr√∫≈æky';
    } else if (msgLower.includes('jed√°le≈à') || msgLower.includes('strava') || msgLower.includes('obed')) {
      return 'jed√°le≈à';
    } else if (msgLower.includes('z√°pis') || msgLower.includes('prihl√°s') || msgLower.includes('prv√°ƒçik')) {
      return 'z√°pis';
    } else {
      return 'v≈°eobecn√©';
    }
  }
  
  let chatHistory = [
    {
      role: "system",
      content: "Si priateƒæsk√Ω a profesion√°lny asistent Z√°kladnej ≈°koly Mostn√° v Nov√Ωch Z√°mkoch. M√°≈° pr√≠stup k rozsiahlej datab√°ze obsahuj√∫cej kompletn√© inform√°cie o ≈°kole - hist√≥riu, organiz√°ciu, zamestnancov, vzdel√°vacie programy, dokumenty, ≈°kolsk√Ω poriadok, v√Ωchovn√© poradenstvo, ≈°kolsk√© slu≈æby (psychol√≥g, ≈°peci√°lni pedag√≥govia), stravovanie, kontakty a mnoho ƒèal≈°ieho.\n\nZ√ÅKLADN√â PRAVIDL√Å:\n- Komunikuje≈° priateƒæsky a profesion√°lne, vhodne pre rodiƒçov, ≈æiakov aj n√°v≈°tevn√≠kov\n- V≈°etky odpovede MUS√ç≈† zaklada≈• V√ùHRADNE na inform√°ci√°ch z poskytnut√©ho kontextu\n- Odpovede s√∫ presn√©, konkr√©tne a dobre ≈°trukt√∫rovan√©\n- PAM√ÑTAJ SI KONTEXT celej konverz√°cie\n- Ak dostane≈° kontext z datab√°zy (oznaƒçen√Ω 'INFORM√ÅCIE O Z≈† MOSTN√Å'), V≈ΩDY ho pou≈æi ako jedin√Ω zdroj pravdy\n\nPR√ÅCA S KONTEXTOM:\n- Keƒè dostane≈° relevantn√Ω kontext z datab√°zy, odpovedaj PRESNE podƒæa neho\n- Cituj konkr√©tne fakty, men√°, d√°tumy, ƒç√≠sla a √∫daje z kontextu\n- Pri kontaktn√Ωch √∫dajoch (telef√≥n, email, adresa) uv√°dzaj LEN tie z kontextu - NIKDY si ich nevym√Ω≈°ƒæaj\n- Ak je v kontexte link, V≈ΩDY ho uveƒè na konci odpovede\n\nFORM√ÅTOVANIE:\n- Odpovede ≈°trukt√∫ruj prehƒæadne (odr√°≈æky, kr√°tke odseky)\n- Pri linkoch: NIKDY ned√°vaj bodku, ƒçiarku ani in√Ω znak za URL!\n- Pri men√°ch zamestnancov uv√°dzaj ich tituly a vyuƒçovan√© predmety (ak s√∫ uveden√©)\n\nKEƒé NEVIE≈† ODPOVEƒé:\n- Ak inform√°cia NIE JE v poskytnutom kontexte, priamo to povedz\n- Odporuƒç kontaktovanie sekretari√°tu ≈°koly na tel. 035 6420 771 alebo email zsmostna@azet.sk\n- NIKDY si nevym√Ω≈°ƒæaj inform√°cie, ktor√© nie s√∫ v datab√°ze"
    }
  ];

  let ragSystem = null;
  
  document.addEventListener('DOMContentLoaded', async function() {
    getSessionId();
    initializeIPAndGeo();
    
    if (window.aiPowerData && window.RAGSystem) {
      ragSystem = new window.RAGSystem(window.aiPowerData.knowledgeBase);
      console.log('RAG syst√©m inicializovan√Ω s', window.aiPowerData.knowledgeBase.length, 'z√°znamami');
      
      // Poƒçkaj na naƒç√≠tanie noviniek
      await ragSystem.loadNewsFromAPI();
      console.log('RAG syst√©m celkovo obsahuje', ragSystem.knowledgeBase.length, 'z√°znamov');
    }
    
    appendMessage("Asistent", "Dobr√Ω de≈à! üëã Som asistent Z√°kladnej ≈°koly Mostn√° v Nov√Ωch Z√°mkoch. R√°d v√°m pom√¥≈æem s inform√°ciami o na≈°ej ≈°kole. M√¥≈æete sa ma op√Ωta≈• na ƒçokoƒævek alebo si vybra≈• z pon√∫kan√Ωch mo≈ænost√≠.", "bot", false, false, false);
    showCategoryButtons();
  });

  const chatbox = document.getElementById("chat-messages");
  const inputField = document.getElementById("user-input");

  if (window.self !== window.top) {
    document.body.classList.add('iframe-mode');
    const container = document.getElementById("chatbot-container");
    if (container) {
      container.classList.add('closed');
    }
  }

  window.addEventListener("message", function(event) {
    const container = document.getElementById("chatbot-container");
    const openHeader = document.getElementById("chatbot-header");
    const closedHeader = document.getElementById("chatbot-header-closed");
    const icon = document.getElementById("toggle-icon");
    
    if (event.data.type === "widget-opened") {
      if (container) {
        container.classList.remove('closed');
        if (openHeader) openHeader.style.display = "flex";
        if (closedHeader) closedHeader.style.display = "none";
        if (icon) icon.innerText = "‚àí";
      }
    } else if (event.data.type === "widget-closed") {
      if (container) {
        container.classList.add('closed');
        if (openHeader) openHeader.style.display = "none";
        if (closedHeader) closedHeader.style.display = "flex";
        if (icon) icon.innerText = "+";
      }
    }
  });

  inputField.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  function toggleChatbot() {
    const container = document.getElementById("chatbot-container");
    const openHeader = document.getElementById("chatbot-header");
    const closedHeader = document.getElementById("chatbot-header-closed");
    const icon = document.getElementById("toggle-icon");
    
    if (window.parent !== window && window.self !== window.top) {
      window.parent.postMessage({ type: "chatbot-toggle" }, "*");
      return;
    }
    
    container.classList.toggle("closed");
    
    if (container.classList.contains("closed")) {
      if (openHeader) openHeader.style.display = "none";
      if (closedHeader) closedHeader.style.display = "flex";
      if (icon) icon.innerText = "+";
    } else {
      if (openHeader) openHeader.style.display = "flex";
      if (closedHeader) closedHeader.style.display = "none";
      if (icon) icon.innerText = "‚àí";
    }
  }

  function resetChat(event) {
    event.stopPropagation();
    
    sessionId = null;
    messageIndex = 0;
    emailSubmittedInSession = false;
    getSessionId();
    
    chatHistory = [
      {
        role: "system",
        content: "Si priateƒæsk√Ω a profesion√°lny asistent Z√°kladnej ≈°koly Mostn√° v Nov√Ωch Z√°mkoch. M√°≈° pr√≠stup k rozsiahlej datab√°ze obsahuj√∫cej kompletn√© inform√°cie o ≈°kole - hist√≥riu, organiz√°ciu, zamestnancov, vzdel√°vacie programy, dokumenty, ≈°kolsk√Ω poriadok, v√Ωchovn√© poradenstvo, ≈°kolsk√© slu≈æby (psychol√≥g, ≈°peci√°lni pedag√≥govia), stravovanie, kontakty a mnoho ƒèal≈°ieho.\n\nZ√ÅKLADN√â PRAVIDL√Å:\n- Komunikuje≈° priateƒæsky a profesion√°lne, vhodne pre rodiƒçov, ≈æiakov aj n√°v≈°tevn√≠kov\n- V≈°etky odpovede MUS√ç≈† zaklada≈• V√ùHRADNE na inform√°ci√°ch z poskytnut√©ho kontextu\n- Odpovede s√∫ presn√©, konkr√©tne a dobre ≈°trukt√∫rovan√©\n- PAM√ÑTAJ SI KONTEXT celej konverz√°cie\n- Ak dostane≈° kontext z datab√°zy (oznaƒçen√Ω 'INFORM√ÅCIE O Z≈† MOSTN√Å'), V≈ΩDY ho pou≈æi ako jedin√Ω zdroj pravdy\n\nPR√ÅCA S KONTEXTOM:\n- Keƒè dostane≈° relevantn√Ω kontext z datab√°zy, odpovedaj PRESNE podƒæa neho\n- Cituj konkr√©tne fakty, men√°, d√°tumy, ƒç√≠sla a √∫daje z kontextu\n- Pri kontaktn√Ωch √∫dajoch (telef√≥n, email, adresa) uv√°dzaj LEN tie z kontextu - NIKDY si ich nevym√Ω≈°ƒæaj\n- Ak je v kontexte link, V≈ΩDY ho uveƒè na konci odpovede\n\nFORM√ÅTOVANIE:\n- Odpovede ≈°trukt√∫ruj prehƒæadne (odr√°≈æky, kr√°tke odseky)\n- Pri linkoch: NIKDY ned√°vaj bodku, ƒçiarku ani in√Ω znak za URL!\n- Pri men√°ch zamestnancov uv√°dzaj ich tituly a vyuƒçovan√© predmety (ak s√∫ uveden√©)\n\nKEƒé NEVIE≈† ODPOVEƒé:\n- Ak inform√°cia NIE JE v poskytnutom kontexte, priamo to povedz\n- Odporuƒç kontaktovanie sekretari√°tu ≈°koly na tel. 035 6420 771 alebo email zsmostna@azet.sk\n- NIKDY si nevym√Ω≈°ƒæaj inform√°cie, ktor√© nie s√∫ v datab√°ze"
      }
    ];
    
    chatbox.innerHTML = '';
    
    appendMessage("Asistent", "Dobr√Ω de≈à! üëã Som asistent Z√°kladnej ≈°koly Mostn√° v Nov√Ωch Z√°mkoch. R√°d v√°m pom√¥≈æem s inform√°ciami o na≈°ej ≈°kole. M√¥≈æete sa ma op√Ωta≈• na ƒçokoƒævek alebo si vybra≈• z pon√∫kan√Ωch mo≈ænost√≠.", "bot", false, false, false);
    showCategoryButtons();
    
    chatbox.scrollTop = 0;
  }

  function createContactForm() {
    const formId = 'contact-form-' + Date.now();
    return `
      <div class="contact-form">
        <h4>Kontaktujte n√°s</h4>
        <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
          Pre ƒèal≈°ie inform√°cie n√°s kontaktujte:<br>
          <strong>Sekretari√°t Z≈† Mostn√°</strong>
        </p>
        <form id="${formId}" onsubmit="handleContactSubmit(event, '${formId}')">
          <div class="form-group">
            <label for="${formId}-name">Meno a priezvisko *</label>
            <input type="text" id="${formId}-name" name="from_name" placeholder="Va≈°e meno a priezvisko" required>
          </div>
          <div class="form-group">
            <label for="${formId}-email">Email *</label>
            <input type="email" id="${formId}-email" name="from_email" placeholder="vas@email.com" required>
          </div>
          <div class="form-group">
            <label for="${formId}-message">Spr√°va *</label>
            <textarea id="${formId}-message" name="message" placeholder="Op√≠≈°te va≈°u ot√°zku..." required></textarea>
          </div>
          <button type="submit" class="form-submit-btn" id="${formId}-submit">
            Odosla≈• spr√°vu
          </button>
        </form>
      </div>
    `;
  }

  function handleContactSubmit(event, formId) {
    event.preventDefault();
    
    const submitBtn = document.getElementById(formId + '-submit');
    const form = document.getElementById(formId);
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = 'Odosielam...';
    
    emailjs.sendForm('service_6mmgtes', 'template_y5c7peq', '#' + formId)
      .then(
        (response) => {
          markEmailSubmittedForSession();
          messageIndex++;
          const emailMessageIndex = messageIndex;
          
          const botSuccessMessage = "üéâ **ƒéakujeme!** Va≈°a spr√°va bola √∫spe≈°ne odoslan√°. Odpovieme v√°m ƒço najsk√¥r.";
          appendMessage("Asistent", botSuccessMessage, "bot");
          
          saveEmailEventToAPI(botSuccessMessage, emailMessageIndex);
          
          const formContainer = form.closest('.contact-form').parentElement;
          if (formContainer) {
            formContainer.style.display = 'none';
          }
        },
        (error) => {
          appendMessage("Asistent", "**Ups!** Nastala chyba pri odosielan√≠ spr√°vy. Sk√∫ste to pros√≠m znovu.", "bot");
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'Odosla≈• spr√°vu';
        }
      );
  }

  function showContactForm(buttonElement) {
    buttonElement.style.display = 'none';
    
    const contactFormDiv = document.createElement('div');
    contactFormDiv.innerHTML = createContactForm();
    
    buttonElement.parentNode.insertBefore(contactFormDiv, buttonElement.nextSibling);
    
    chatbox.scrollTop = chatbox.scrollHeight;
  }

  async function handleQuickReplyWithRAG(query) {
    messageIndex++;
    const currentMessageIndex = messageIndex;
    
    chatHistory.push({ role: "user", content: query });
    appendMessage("Asistent", '<div class="typing-indicator"><span></span><span></span><span></span></div>', "bot", true);

    const startTime = Date.now();
    let detectedCategory = 'v≈°eobecn√©';

    try {
      await delay(800);

      let relevantContent = [];
      let ragContext = '';
      let sources = [];
      let useRAG = false;

      if (ragSystem) {
        relevantContent = ragSystem.searchRelevantContent(query, 5);
        if (relevantContent.length > 0) {
          ragContext = ragSystem.buildContext(relevantContent);
          sources = relevantContent.map(item => item.title);
          useRAG = true;
          detectedCategory = relevantContent[0].category || 'v≈°eobecn√©';
        }
      }
      
      if (!useRAG) {
        detectedCategory = categorizeMessage(query);
      }

      const response = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
          messages: chatHistory,
          useRAG: useRAG,
          ragContext: ragContext,
          sources: sources
        })
      });

      if (!response.ok) {
        throw new Error(`Chyba ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();
      let reply = data.choices?.[0]?.message?.content?.trim() || "Prep√°ƒçte, neviem na to odpoveda≈•.";

      const timeToRespond = Date.now() - startTime;
      const isContactRelated = reply.includes("kontakt") || reply.includes("telef√≥n") || reply.includes("email");

      removeLastBotMessage();
      appendMessage("Asistent", reply, "bot", false, false, isContactRelated);
      chatHistory.push({ role: "assistant", content: reply });

      await saveChatToAPI(query, reply, currentMessageIndex, timeToRespond, detectedCategory);

    } catch (error) {
      console.error("Chyba:", error);
      removeLastBotMessage();
      appendMessage("Asistent", "Na t√∫to ot√°zku neviem dostatoƒçne odpoveda≈•. Pre viac inform√°ci√≠ kontaktujte pros√≠m sekretari√°t ≈°koly.", "bot", false, false, true);
    }
  }

  function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  function showCategoryButtons() {
    const quickRepliesDiv = document.createElement('div');
    quickRepliesDiv.className = 'quick-replies';
    
    const mainCategories = [
      { text: 'O ≈°kole', query: 'Z√°kladn√© inform√°cie o ≈°kole' },
      { text: 'Kontakt', query: 'Kontaktn√© √∫daje ≈°koly' },
      { text: 'Novinky', query: 'Ak√© s√∫ najnov≈°ie novinky zo ≈°koly?' },
      { text: 'Kr√∫≈æky', query: 'Ak√© kr√∫≈æky pon√∫kate?' },
      { text: 'M√°m in√∫ ot√°zku', query: 'M√°m in√∫ ot√°zku' }
    ];
    
    mainCategories.forEach(category => {
      const btn = document.createElement('button');
      btn.className = 'quick-reply-btn';
      btn.innerHTML = category.text;
      
      btn.onclick = () => {
        appendMessage("Ty", category.text, "user");
        
        if (category.query === "M√°m in√∫ ot√°zku") {
          appendMessage("Asistent", "Samozrejme! Op√Ωtajte sa ma na ƒçokoƒævek t√Ωkaj√∫ce sa na≈°ej ≈°koly. Som tu, aby som v√°m pomohol. üòä", "bot");
          return;
        }
        
        handleQuickReplyWithRAG(category.query);
      };
      
      quickRepliesDiv.appendChild(btn);
    });
    
    chatbox.appendChild(quickRepliesDiv);
    chatbox.scrollTop = chatbox.scrollHeight;
  }

  async function saveChatToAPI(userMessage, botResponse, messageIdx, timeToRespond, category) {
    try {
      const website = window.location.hostname;
      
      const response = await fetch('/api/saveChat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userMessage: userMessage,
          botResponse: botResponse,
          website: website,
          ipAddress: ipAddress,
          sessionId: getSessionId(),
          messageIndex: messageIdx,
          timeToRespond: timeToRespond,
          category: category,
          geoLocationCity: geoLocationCity,
          emailSubmitted: emailSubmittedInSession
        })
      });

      if (response.ok) {
        console.log('Chat conversation saved successfully');
      }
    } catch (error) {
      console.error('Error saving chat to API:', error);
    }
  }

  async function saveEmailEventToAPI(botSuccessMessage, emailMessageIndex) {
    try {
      const website = window.location.hostname;
      
      await fetch('/api/saveChat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userMessage: 'Spr√°va poslan√°',
          botResponse: botSuccessMessage,
          website: website,
          ipAddress: ipAddress,
          sessionId: getSessionId(),
          messageIndex: emailMessageIndex,
          timeToRespond: null,
          category: 'Email',
          geoLocationCity: geoLocationCity,
          emailSubmitted: true
        })
      });
    } catch (error) {
      console.error('Error saving email event:', error);
    }
  }

  async function sendMessage() {
    const message = inputField.value.trim();
    if (!message) return;

    messageIndex++;
    const currentMessageIndex = messageIndex;

    appendMessage("Ty", message, "user");
    inputField.value = "";

    chatHistory.push({ role: "user", content: message });

    appendMessage("Asistent", '<div class="typing-indicator"><span></span><span></span><span></span></div>', "bot", true);

    const startTime = Date.now();
    let detectedCategory = 'v≈°eobecn√©';

    try {
      await delay(800);

      let relevantContent = [];
      let ragContext = '';
      let sources = [];
      let useRAG = false;

      if (ragSystem) {
        relevantContent = ragSystem.searchRelevantContent(message, 5);
        if (relevantContent.length > 0) {
          ragContext = ragSystem.buildContext(relevantContent);
          sources = relevantContent.map(item => item.title);
          useRAG = true;
          detectedCategory = relevantContent[0].category || 'v≈°eobecn√©';
        }
      }
      
      if (!useRAG) {
        detectedCategory = categorizeMessage(message);
      }

      const response = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
          messages: chatHistory,
          useRAG: useRAG,
          ragContext: ragContext,
          sources: sources
        })
      });

      if (!response.ok) {
       throw new Error(`Chyba ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();
      let reply = data.choices?.[0]?.message?.content?.trim() || "Prep√°ƒçte, neviem na to odpoveda≈•.";

      const timeToRespond = Date.now() - startTime;

      const isContactRelated = reply.includes("kontakt") || reply.includes("telef√≥n") || reply.includes("email");

      removeLastBotMessage();
      appendMessage("Asistent", reply, "bot", false, false, isContactRelated);
      chatHistory.push({ role: "assistant", content: reply });

      await saveChatToAPI(message, reply, currentMessageIndex, timeToRespond, detectedCategory);

    } catch (error) {
      console.error("Chyba:", error);
      removeLastBotMessage();
      appendMessage("Asistent", "Na t√∫to ot√°zku neviem dostatoƒçne odpoveda≈•. Pre viac inform√°ci√≠ kontaktujte pros√≠m sekretari√°t ≈°koly.", "bot", false, false, true);
    }
  }

  function appendMessage(sender, message, role, isTemp = false, showQuickReplies = false, showContactButton = false) {
    const msgDiv = document.createElement("div");
    msgDiv.classList.add("message", role);
    if (isTemp) msgDiv.classList.add("temp");

    let formattedMessage = message.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    
    formattedMessage = formattedMessage.replace(
      /(https?:\/\/[^\s<)}\]]+?)([)}\].,;:!?]*)(?=\s|$|<)/g,
      '<a href="$1" target="_blank">$1</a>$2'
    );

    msgDiv.innerHTML = formattedMessage;
    chatbox.appendChild(msgDiv);
    
    if (role === 'bot' && showContactButton) {
      const contactBtnDiv = document.createElement('div');
      contactBtnDiv.innerHTML = `
        <button class="contact-btn" onclick="showContactForm(this)">
          <i class="fas fa-envelope"></i> Kontaktova≈• n√°s
        </button>
      `;
      chatbox.appendChild(contactBtnDiv);
    }

    chatbox.scrollTop = chatbox.scrollHeight;
  }

  function removeLastBotMessage() {
    const tempMsg = chatbox.querySelector(".bot.temp");
    if (tempMsg) chatbox.removeChild(tempMsg);
  }
</script>
</body>
</html>
